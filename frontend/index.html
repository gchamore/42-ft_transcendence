<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>42 Transcendence</title>
    <style>
        body {
            background-color: #121212;
            color: #eee;
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background-color: #1e1e1e;
            padding: 2rem;
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
        }
        h1 {
            color: #00babc;
            text-align: center;
            margin-bottom: 2rem;
        }
        .forms {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        input {
            width: 100%;
            padding: 0.5rem;
            margin: 0.5rem 0;
            border: 1px solid #444;
            background: #2d2d2d;
            color: white;
            border-radius: 4px;
        }
        button {
            width: 100%;
            padding: 0.5rem;
            background: #00babc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .message {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
            text-align: center;
        }
        .error { background: #c62828; }
        .success { background: #2e7d32; }
        .hidden { display: none; }

        .search-container {
            display: flex;
            gap: 0.5rem;
            margin: 1rem 0;
        }
        
        .search-container input {
            flex: 1;
        }
        
        .search-container button {
            width: auto;
            padding: 0.5rem 1rem;
        }

        .search-result {
            margin-top: 1rem;
            padding: 1rem;
            background: #2d2d2d;
            border-radius: 4px;
            display: none;
        }

        /* Styles pour la friendlist */
        .friend-list {
            margin-top: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .friend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: #2d2d2d;
            margin: 0.5rem 0;
            border-radius: 4px;
        }

        .friend-info {
            flex-grow: 1;
            margin-right: 1rem; /* Ajouter de l'espace entre le nom et le bouton */
        }

        .friend-actions {
            margin-left: 1rem;
        }

        .remove-friend-btn {
            background: #c62828;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .add-friend-btn {
            background: #2e7d32;
            padding: 0.25rem 0.75rem; /* Réduire le padding */
            font-size: 0.9rem; /* Réduire la taille de la police */
            margin: 0; /* Supprimer la marge */
            width: auto; /* Le bouton ne prendra que la largeur nécessaire */
            white-space: nowrap; /* Empêcher le texte de passer à la ligne */
        }

        .friend-stats {
            font-size: 0.8rem;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>42 Transcendence</h1>
        <div id="message" class="message hidden"></div>

        <div id="auth-forms" class="forms">
            <form id="register-form">
                <h2>Register</h2>
                <input type="text" id="register-username" placeholder="Username" required>
                <input type="password" id="register-password" placeholder="Password" required>
                <button type="submit">Register</button>
            </form>

            <form id="login-form">
                <h2>Login</h2>
                <input type="text" id="login-username" placeholder="Username" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="submit">Login</button>
            </form>

            <button id="verify-token-btn" style="margin-top: 1rem;">Verify Token</button>
        </div>

        <div id="welcome" class="hidden">
            <h2>Welcome, <span id="username"></span>!</h2>
            
            <!-- Ajout du bouton friendlist -->
            <button id="show-friends-btn" style="margin: 1rem 0;">Show Friends</button>
            
            <!-- Container pour la liste d'amis -->
            <div id="friend-list" class="friend-list hidden"></div>
            
            <div class="search-container">
                <input type="text" id="search-username" placeholder="Search username">
                <button id="search-btn">Search</button>
            </div>
            <div id="search-result" class="search-result"></div>
            
            <button id="verify-token-logged-btn" style="margin-top: 1rem;">Verify Token</button>
            <button id="revoke-tokens-btn" style="margin-top: 1rem;">Revoke Tokens</button>
            <button id="logout-btn" style="margin-top: 1rem;">Logout</button>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8080/api';
        const WS_URL = 'ws://localhost:8080/api/ws';
        let ws = null;
        
        const message = document.getElementById('message');
        const authForms = document.getElementById('auth-forms');
        const welcome = document.getElementById('welcome');
        
        // Vérifier l'authentification au chargement
        checkAuth();

        // Vérifier s'il y a un message stocké dans sessionStorage
        window.addEventListener('load', () => {
            const pendingMessage = sessionStorage.getItem('pendingMessage');
            const messageType = sessionStorage.getItem('messageType');
            if (pendingMessage) {
                showMessage(pendingMessage, messageType === 'error');
                sessionStorage.removeItem('pendingMessage');
                sessionStorage.removeItem('messageType');
            }
        });

        // Modifier checkAuth pour mettre à jour le localStorage
        async function checkAuth() {
            try {
                const response = await fetch(`${API_URL}/verify_token`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.valid) {
                        // Mettre à jour le localStorage avec l'utilisateur actuel
                        localStorage.setItem('currentUser', data.username);
                        showWelcome(data.username);
                    } else {
                        // Nettoyer le localStorage si le token n'est pas valide
                        localStorage.clear();
                    }
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                localStorage.clear();
            }
        }

        // Register
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;

            try {
                const response = await fetch(`${API_URL}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password }),
                    credentials: 'include'
                });

                const data = await response.json();
                
                if (response.ok) {
                    // Ajouter cette ligne pour mettre à jour le localStorage lors du register
                    localStorage.setItem('currentUser', username);
                    
                    showMessage('Registration and login successful!', false);
                    document.getElementById('register-form').reset();
                    // Directement afficher le welcome puisque l'utilisateur est connecté
                    showWelcome(data.username);
                } else {
                    showMessage(data.error || 'Registration failed', true);
                }
            } catch (error) {
                showMessage('Server error', true);
            }
        });

        // Login
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            // Sauvegarder le nom d'utilisateur dans le localStorage
            localStorage.setItem('currentUser', username);

            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password }),
                    credentials: 'include'
                });

                const data = await response.json();
                
                if (response.ok) {
                    showMessage('Login successful!', false);
                    showWelcome(data.username);
                } else {
                    showMessage(data.error || 'Login failed', true);
                }
            } catch (error) {
                showMessage('Server error', true);
                console.error('Login error:', error);
            }
        });

        // Fonction commune de vérification de token
        async function verifyToken() {
            try {
                const response = await fetch(`${API_URL}/verify_token`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.valid) {
                        showMessage('Token is valid! User: ' + data.username, false);
                    } else {
                        showMessage('Token is invalid', true);
                    }
                } else {
                    showMessage('Token verification failed', true);
                }
            } catch (error) {
                showMessage('Verification error', true);
                console.error('Verify error:', error);
            }
        }

        // Ajout des event listeners pour les boutons verify-token
        document.getElementById('verify-token-btn').addEventListener('click', verifyToken);
        document.getElementById('verify-token-logged-btn').addEventListener('click', verifyToken);

        // fonction logout
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                if (ws) {
                    ws.close();  // Fermer la connexion WebSocket
                }
                const response = await fetch(`${API_URL}/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    localStorage.clear();
                    showMessage('Logged out successfully', false);
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    const data = await response.json();
                    showMessage(data.error || 'Logout failed', true);
                }
            } catch (error) {
                console.error('Logout error:', error);
                showMessage('Server error during logout', true);
            }
        });

        // Ajouter la fonction de recherche d'utilisateur
        document.getElementById('search-btn').addEventListener('click', async () => {
            const searchUsername = document.getElementById('search-username').value;
            const searchResult = document.getElementById('search-result');
            
            if (!searchUsername) {
                showMessage('Please enter a username', true);
                return;
            }

            try {
                const [userResponse, statusResponse] = await Promise.all([
                    fetch(`${API_URL}/isUser/${searchUsername}`, {
                        credentials: 'include'
                    }),
                    fetch(`${API_URL}/online-status/${searchUsername}`, {
                        credentials: 'include'
                    })
                ]);

                const userData = await userResponse.json();
                const statusData = await statusResponse.json();
                
                searchResult.style.display = 'block';
                if (userData.exists) {
                    searchResult.innerHTML = `
                        <div class="friend-item" data-username="${searchUsername}">
                            <div class="friend-info">
                                <strong>${searchUsername}</strong>
                                <span class="status-badge ${statusData.online ? 'online' : 'offline'}">
                                    ${statusData.online ? 'Online' : 'Offline'}
                                </span>
                            </div>
                            <button class="add-friend-btn" onclick="addFriend('${searchUsername}')">
                                Add Friend
                            </button>
                        </div>
                    `;
                } else {
                    searchResult.innerHTML = `<p>User '${searchUsername}' not found.</p>`;
                }
            } catch (error) {
                console.error('Search error:', error);
                showMessage('Error during search', true);
            }
        });

        // Fonction d'ajout d'ami
        async function addFriend(friendUsername) {
            const storedUsername = localStorage.getItem('currentUser');
            const currentUsername = document.getElementById('username').textContent;
            
            if (storedUsername !== currentUsername) {
                showMessage('Session invalid: Please refresh the page', true);
                return;
            }

            if (friendUsername === currentUsername) {
                showMessage('Cannot add yourself as friend', true);
                return;
            }

            try {
                const response = await fetch(`${API_URL}/add_friend`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ friendUsername }),
                    credentials: 'include'
                });

                const data = await response.json();
                if (data.success) {
                    showMessage(data.message, false);
                    // Rafraîchir la liste si elle est visible
                    if (!document.getElementById('friend-list').classList.contains('hidden')) {
                        document.getElementById('show-friends-btn').click();
                    }
                } else {
                    showMessage(data.error || 'Failed to add friend', true);
                }
            } catch (error) {
                console.error('Add friend error:', error);
                showMessage('Failed to add friend', true);
            }
        }

        // Ajout de la gestion du bouton revoke-tokens
        document.getElementById('revoke-tokens-btn').addEventListener('click', async () => {
            const username = document.getElementById('username').textContent;
            
            try {
                // D'abord récupérer l'ID de l'utilisateur
                const getUserIdResponse = await fetch(`${API_URL}/getUserId`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username }),
                    credentials: 'include'
                });

                const userIdData = await getUserIdResponse.json();

                if (!userIdData.success) {
                    throw new Error('Failed to get user ID');
                }

                // Ensuite révoquer les tokens
                const response = await fetch(`${API_URL}/revoke`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: userIdData.id }),
                    credentials: 'include'
                });

                const data = await response.json();
                
                if (response.ok) {
                    showMessage('Tokens revoked successfully', false);
                    // Rediriger vers la page de login
                    authForms.classList.remove('hidden');
                    welcome.classList.add('hidden');
                } else {
                    showMessage(data.error || 'Failed to revoke tokens', true);
                }
            } catch (error) {
                console.error('Revoke error:', error);
                showMessage('Error during token revocation', true);
            }
        });

        // Gestion de la liste d'amis
        document.getElementById('show-friends-btn').addEventListener('click', async () => {
            const friendList = document.getElementById('friend-list');
            friendList.classList.toggle('hidden');

            if (!friendList.classList.contains('hidden')) {
                try {
                    const response = await fetch(`${API_URL}/friends`, {
                        credentials: 'include'
                    });
                    const data = await response.json();

                    if (data.success) {
                        friendList.innerHTML = data.friends.map(friend => `
                            <div class="friend-item">
                                <div class="friend-info">
                                    <strong>${friend.username}</strong>
                                    <div class="friend-stats">
                                        Wins: ${friend.wins} | Losses: ${friend.losses}
                                        <br>Friends since: ${new Date(friend.friend_since).toLocaleDateString()}
                                    </div>
                                </div>
                                <div class="friend-actions">
                                    <button class="remove-friend-btn" onclick="removeFriend(${friend.id})">
                                        Remove
                                    </button>
                                </div>
                            </div>
                        `).join('') || '<p>No friends yet</p>';
                    }
                } catch (error) {
                    console.error('Failed to fetch friends:', error);
                    showMessage('Failed to load friends', true);
                }
            }
        });

        // Fonction de suppression d'ami
        async function removeFriend(friendId) {
            try {
                const response = await fetch(`${API_URL}/remove_friend/${friendId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const data = await response.json();
                if (data.success) {
                    showMessage('Friend removed successfully', false);
                    // Rafraîchir la liste
                    document.getElementById('show-friends-btn').click();
                } else {
                    showMessage(data.error || 'Failed to remove friend', true);
                }
            } catch (error) {
                console.error('Remove friend error:', error);
                showMessage('Failed to remove friend', true);
            }
        }

        // Vérifier régulièrement si l'utilisateur actuel est toujours valide
        setInterval(async () => {
            const storedUsername = localStorage.getItem('currentUser');
            const currentUsername = document.getElementById('username').textContent;
            
            if (storedUsername && currentUsername && storedUsername !== currentUsername) {
                // L'utilisateur a changé dans un autre onglet
                showMessage('Session expired: Another user logged in', true);
                document.getElementById('logout-btn').click();
            }
        }, 1000);

        function showMessage(text, isError = false) {
            message.textContent = text;
            message.className = `message ${isError ? 'error' : 'success'}`;
            setTimeout(() => message.className = 'message hidden', 5000);
        }

        function showWelcome(username) {
            document.getElementById('username').textContent = username;
            authForms.classList.add('hidden');
            welcome.classList.remove('hidden');
            connectWebSocket();  // Établir la connexion WebSocket
        }

        // Fonction pour établir la connexion WebSocket avec reconnexion automatique
        function connectWebSocket() {
            if (ws) {
                ws.close();
            }

            ws = new WebSocket(WS_URL);
            let reconnectTimeout;

            ws.onopen = () => {
                console.log('WebSocket connected');
                clearTimeout(reconnectTimeout);
                // Demander la liste des utilisateurs en ligne
                ws.send(JSON.stringify({ type: 'get_online_users' }));
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                switch (data.type) {
                    case 'status_update':
                        updateUserStatus(data);
                        break;
                    case 'online_users':
                        updateOnlineUsers(data.users);
                        break;
                }
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                // Tentative de reconnexion après 5 secondes
                reconnectTimeout = setTimeout(() => {
                    connectWebSocket();
                }, 5000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        // Mise à jour du statut d'un utilisateur
        function updateUserStatus(data) {
            const searchResult = document.getElementById('search-result');
            const userElement = searchResult.querySelector(`[data-username="${data.username}"]`);
            
            if (userElement) {
                const statusBadge = userElement.querySelector('.status-badge');
                statusBadge.textContent = data.online ? 'Online' : 'Offline';
                statusBadge.className = `status-badge ${data.online ? 'online' : 'offline'}`;
            }
        }

        // Mise à jour de la liste des utilisateurs en ligne
        function updateOnlineUsers(onlineUsers) {
            const friendList = document.getElementById('friend-list');
            const friends = friendList.querySelectorAll('.friend-item');
            
            friends.forEach(friend => {
                const userId = friend.dataset.userId;
                const statusBadge = friend.querySelector('.status-badge');
                if (statusBadge) {
                    const isOnline = onlineUsers.includes(userId);
                    statusBadge.textContent = isOnline ? 'Online' : 'Offline';
                    statusBadge.className = `status-badge ${isOnline ? 'online' : 'offline'}`;
                }
            });
        }

        // Ajouter des styles pour les badges de statut
        const style = document.createElement('style');
        style.textContent = `
            .status-badge {
                padding: 2px 6px;
                border-radius: 10px;
                font-size: 0.8em;
                margin-left: 8px;
            }
            .status-badge.online {
                background-color: #2e7d32;
                color: white;
            }
            .status-badge.offline {
                background-color: #c62828;
                color: white;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>