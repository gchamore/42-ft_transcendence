<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>42 Transcendence</title>
    <style>
        body {
            background-color: #121212;
            color: #eee;
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .container {
            background-color: #1e1e1e;
            padding: 2rem;
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
        }

        h1 {
            color: #00babc;
            text-align: center;
            margin-bottom: 2rem;
        }

        .forms {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        input {
            width: 100%;
            padding: 0.5rem;
            margin: 0.5rem 0;
            border: 1px solid #444;
            background: #2d2d2d;
            color: white;
            border-radius: 4px;
        }

        button {
            width: 100%;
            padding: 0.5rem;
            background: #00babc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .message {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
            text-align: center;
        }

        .error {
            background: #c62828;
        }

        .success {
            background: #2e7d32;
        }

        .hidden {
            display: none;
        }

        .search-container {
            display: flex;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .search-container input {
            flex: 1;
        }

        .search-container button {
            width: auto;
            padding: 0.5rem 1rem;
        }

        .search-result {
            margin-top: 1rem;
            padding: 1rem;
            background: #2d2d2d;
            border-radius: 4px;
            display: none;
        }

        /* Styles pour la friendlist */
        .friend-list {
            margin-top: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .friend-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 0.8rem;
            background: #2d2d2d;
            margin: 0.5rem 0;
            border-radius: 4px;
        }

        .friend-info {
            flex-grow: 1;
            margin-right: 1rem;
            /* Ajouter de l'espace entre le nom et le bouton */
        }

        .user-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            flex-wrap: nowrap;
        }

        .username {
            font-weight: bold;
            margin-right: 0.5rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }

        .friend-actions {
            margin-left: 1rem;
        }

        .remove-friend-btn {
            background: #c62828;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .add-friend-btn {
            background: #2e7d32;
            padding: 0.25rem 0.75rem;
            /* RÃ©duire le padding */
            font-size: 0.9rem;
            /* RÃ©duire la taille de la police */
            margin: 0;
            /* Supprimer la marge */
            width: auto;
            /* Le bouton ne prendra que la largeur nÃ©cessaire */
            white-space: nowrap;
            /* EmpÃªcher le texte de passer Ã  la ligne */
        }

        .friend-stats {
            font-size: 0.8rem;
            color: #888;
        }

        .user-stats {
            margin-top: 0.5rem;
            font-size: 0.9em;
            color: #aaa;
        }

        .status-badge {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.8em;
            margin-left: 8px;
        }

        .status-online {
            background-color: #2e7d32;
            color: white;
        }

        .status-offline {
            background-color: #c62828;
            color: white;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>42 Transcendence</h1>
        <div id="message" class="message hidden"></div>

        <div id="auth-forms" class="forms">
            <form id="register-form">
                <h2>Register</h2>
                <input type="text" id="register-username" placeholder="Username" required>
                <input type="password" id="register-password" placeholder="Password" required>
                <button type="submit">Register</button>
            </form>

            <form id="login-form">
                <h2>Login</h2>
                <input type="text" id="login-username" placeholder="Username" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="submit">Login</button>
            </form>

            <button id="verify-token-btn" style="margin-top: 1rem;">Verify Token</button>
            <button id="google-login-btn">Login with Google</button>
        </div>

        <div id="welcome" class="hidden">
            <h2>Welcome, <span id="username"></span>!</h2>

            <div class="search-container">
                <input type="text" id="search-username" placeholder="Search username">
                <button id="search-btn">Search</button>
            </div>
            <div id="search-result" class="search-result"></div>

            <button id="verify-token-logged-btn" style="margin-top: 1rem;">Verify Token</button>
            <button id="revoke-tokens-btn" style="margin-top: 1rem;">Revoke Tokens</button>
            <button id="logout-btn" style="margin-top: 1rem;">Logout</button>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8080/api';
        const WS_URL = 'ws://localhost:8080/api/ws';
        const GOOGLE_CLIENT_ID = '719179054785-mb2t4o5tddvfbmq7298bt49cgd7ob2c3.apps.googleusercontent.com';
        const GOOGLE_REDIRECT_URI = 'http://localhost:8080/auth/callback';
        let ws = null;
        let shouldReconnect = true; // Nouveau flag pour contrÃ´ler la reconnexion

        const message = document.getElementById('message');
        const authForms = document.getElementById('auth-forms');
        const welcome = document.getElementById('welcome');

        // VÃ©rifier l'authentification au chargement
        checkAuth();

        // VÃ©rifier s'il y a un message stockÃ© dans sessionStorage
        window.onload = async () => {
            // ðŸ”¥ 1. VÃ©rifie s'il y a un message en attente dans sessionStorage
            const pendingMessage = sessionStorage.getItem('pendingMessage');
            const messageType = sessionStorage.getItem('messageType');
            if (pendingMessage) {
                showMessage(pendingMessage, messageType === 'error');
                sessionStorage.removeItem('pendingMessage');
                sessionStorage.removeItem('messageType');
            }

            // ðŸ”¥ 2. VÃ©rifie si Google OAuth a renvoyÃ© un code dans l'URL
            const urlParams = new URLSearchParams(window.location.search);
            const googleCode = urlParams.get('code');

            if (googleCode) {
                try {
                    const response = await fetch(`${API_URL}/auth/google/callback`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ code: googleCode }),
                        credentials: 'include'
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        showMessage('Google Login successful!', false);
                        showWelcome(data.username); // Charge l'espace connectÃ©
                        window.history.replaceState({}, document.title, '/'); // Nettoie l'URL
                    } else {
                        showMessage(data.error || 'Google Login failed', true);
                    }
                } catch (error) {
                    console.error('Google OAuth callback error:', error);
                    showMessage('Google OAuth callback error', true);
                }
            }
        };


        // Modifier checkAuth pour mettre Ã  jour le localStorage
        async function checkAuth() {
            try {
                const response = await fetch(`${API_URL}/verify_token`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.valid) {
                        // Mettre Ã  jour le localStorage avec l'utilisateur actuel
                        localStorage.setItem('currentUser', data.username);
                        showWelcome(data.username);
                    } else {
                        // Nettoyer le localStorage si le token n'est pas valide
                        localStorage.clear();
                    }
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                localStorage.clear();
            }
        }

        // Fonction pour vÃ©rifier si les tokens sont valides
        async function areTokensValid() {
            try {
                const response = await fetch(`${API_URL}/verify_token`, {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await response.json();
                return data.valid;
            } catch (error) {
                console.error('Token validation error:', error);
                return false;
            }
        }

        // Register
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;

            try {
                const response = await fetch(`${API_URL}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password }),
                    credentials: 'include'
                });

                const data = await response.json();

                if (response.ok) {
                    // Ajouter cette ligne pour mettre Ã  jour le localStorage lors du register
                    localStorage.setItem('currentUser', username);

                    showMessage('Registration and login successful!', false);
                    document.getElementById('register-form').reset();
                    // Directement afficher le welcome puisque l'utilisateur est connectÃ©
                    showWelcome(data.username);
                } else {
                    showMessage(data.error || 'Registration failed', true);
                }
            } catch (error) {
                showMessage('Server error', true);
            }
        });

        // Login
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            // Sauvegarder le nom d'utilisateur dans le localStorage
            localStorage.setItem('currentUser', username);

            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password }),
                    credentials: 'include'
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('Login successful!', false);
                    showWelcome(data.username);
                } else {
                    showMessage(data.error || 'Login failed', true);
                }
            } catch (error) {
                showMessage('Server error', true);
                console.error('Login error:', error);
            }
        });

        // Fonction commune de vÃ©rification de token
        async function verifyToken() {
            try {
                const response = await fetch(`${API_URL}/verify_token`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.valid) {
                        showMessage('Token is valid! User: ' + data.username, false);
                    } else {
                        showMessage('Token is invalid', true);
                    }
                } else {
                    showMessage('Token verification failed', true);
                }
            } catch (error) {
                showMessage('Verification error', true);
                console.error('Verify error:', error);
            }
        }

        // Ajout des event listeners pour les boutons verify-token
        document.getElementById('verify-token-btn').addEventListener('click', verifyToken);
        document.getElementById('verify-token-logged-btn').addEventListener('click', verifyToken);
        document.getElementById('google-login-btn').addEventListener('click', () => {
            const googleAuthUrl = `https://accounts.google.com/o/oauth2/auth?client_id=${GOOGLE_CLIENT_ID}&redirect_uri=${GOOGLE_REDIRECT_URI}&response_type=code&scope=email profile&access_type=online`;
            window.location.href = googleAuthUrl;
        });

        // fonction logout
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                if (ws) {
                    ws.close();  // Fermer la connexion WebSocket
                }
                const response = await fetch(`${API_URL}/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    localStorage.clear();
                    showMessage('Logged out successfully', false);
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    const data = await response.json();
                    showMessage(data.error || 'Logout failed', true);
                }
            } catch (error) {
                console.error('Logout error:', error);
                showMessage('Server error during logout', true);
            }
        });

        // Remplacer les deux event listeners de recherche par celui-ci
        document.getElementById('search-btn').addEventListener('click', async () => {
            const searchUsername = document.getElementById('search-username').value;
            const searchResult = document.getElementById('search-result');

            if (!searchUsername) {
                showMessage('Please enter a username', true);
                return;
            }

            try {
                const response = await fetch(`${API_URL}/search/${searchUsername}`, {
                    credentials: 'include'
                });

                const data = await response.json();

                if (response.status === 404) {
                    searchResult.style.display = 'block';
                    searchResult.innerHTML = `<p>User '${searchUsername}' not found.</p>`;
                    return;
                }

                if (!response.ok) {
                    throw new Error(data.error || 'Search failed');
                }

                searchResult.style.display = 'block';
                if (data.success) {
                    let statsHtml = '';

                    if (data.isFriend) {
                        // Affichage pour un ami
                        statsHtml = `
                            <div class="user-stats">
                                <p>Friend since: ${data.user.friendSince}</p>
                                <p>Games together: ${data.user.gamesTogether}</p>
                                <p>Wins together: ${data.user.winsTogether}</p>
                                <p>Total games: ${data.user.gamesPlayed}</p>
                                <p>Win rate: ${data.user.winRate}%</p>
                            </div>
                        `;
                    } else {
                        // Affichage pour un non-ami
                        statsHtml = `
                            <div class="user-stats">
                                <p>Member since: ${data.user.createdAt}</p>
                                <p>Total games: ${data.user.gamesPlayed}</p>
                                <p>Win rate: ${data.user.winRate}%</p>
                            </div>
                        `;
                    }

                    const statusBadge = data.isFriend ? `
                        <span class="status-badge ${data.user.isConnected ? 'status-online' : 'status-offline'}">
                            ${data.user.isConnected ? 'Online' : 'Offline'}
                        </span>
                    ` : '';

                    // Dans la fonction de recherche, modifier l'affichage pour inclure le bouton de suppression si c'est un ami
                    searchResult.innerHTML = `
                        <div class="friend-item" data-username="${data.user.username}">
                            <div class="friend-info">
                                <div class="user-header">
                                    <span class="username">${data.user.username}</span>
                                    ${data.isFriend ? `
                                        <span class="status-badge ${data.user.isConnected ? 'status-online' : 'status-offline'}">
                                            ${data.user.isConnected ? 'Online' : 'Offline'}
                                        </span>
                                    ` : ''}
                                </div>
                                ${statsHtml}
                            </div>
                            ${data.isFriend ? `
                                <button class="remove-friend-btn" onclick="removeFriend('${data.user.username}')">
                                    Remove
                                </button>
                            ` : `
                                <button class="add-friend-btn" onclick="addFriend('${data.user.username}')">
                                    Add
                                </button>
                            `}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Search error:', error);
                showMessage('Error during search', true);
            }
        });

        // Fonction d'ajout d'ami
        async function addFriend(friendUsername) {
            const storedUsername = localStorage.getItem('currentUser');
            const currentUsername = document.getElementById('username').textContent;

            if (storedUsername !== currentUsername) {
                showMessage('Session invalid: Please refresh the page', true);
                return;
            }

            if (friendUsername === currentUsername) {
                showMessage('Cannot add yourself as friend', true);
                return;
            }

            try {
                const response = await fetch(`${API_URL}/add/${friendUsername}`, {
                    method: 'POST',
                    credentials: 'include'
                });

                const data = await response.json();
                if (data.success) {
                    showMessage('Friend added successfully', false);
                    // RafraÃ®chir la recherche
                    document.getElementById('search-btn').click();
                } else {
                    showMessage(data.error || 'Failed to add friend', true);
                }
            } catch (error) {
                console.error('Add friend error:', error);
                showMessage('Failed to add friend', true);
            }
        }

        // Fonction de suppression d'ami
        async function removeFriend(friendUsername) {
            try {
                const response = await fetch(`${API_URL}/remove/${friendUsername}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const data = await response.json();
                if (data.success) {
                    showMessage('Friend removed successfully', false);
                    // RafraÃ®chir la recherche
                    document.getElementById('search-btn').click();
                } else {
                    showMessage(data.error || 'Failed to remove friend', true);
                }
            } catch (error) {
                console.error('Remove friend error:', error);
                showMessage('Failed to remove friend', true);
            }
        }

        // Ajout de la gestion du bouton revoke-tokens
        document.getElementById('revoke-tokens-btn').addEventListener('click', async () => {
            const username = document.getElementById('username').textContent;

            try {
                shouldReconnect = false; // DÃ©sactiver les reconnexions avant la rÃ©vocation

                if (ws) {
                    ws.close();
                    ws = null;
                }

                // D'abord rÃ©cupÃ©rer l'ID de l'utilisateur
                const getUserIdResponse = await fetch(`${API_URL}/getUserId`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username }),
                    credentials: 'include'
                });

                const userIdData = await getUserIdResponse.json();

                if (!userIdData.success) {
                    throw new Error('Failed to get user ID');
                }

                // Ensuite rÃ©voquer les tokens
                const response = await fetch(`${API_URL}/revoke`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: userIdData.id }),
                    credentials: 'include'
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('Tokens revoked successfully', false);
                    authForms.classList.remove('hidden');
                    welcome.classList.add('hidden');
                    localStorage.clear();
                } else {
                    showMessage(data.error || 'Failed to revoke tokens', true);
                }
            } catch (error) {
                console.error('Revoke error:', error);
                showMessage('Error during token revocation', true);
            }
        });

        // Supprimer l'event listener du bouton show-friends et la fonction loadFriends
        document.getElementById('show-friends-btn')?.remove();


        // VÃ©rifier rÃ©guliÃ¨rement si l'utilisateur actuel est toujours valide
        setInterval(async () => {
            const storedUsername = localStorage.getItem('currentUser');
            const currentUsername = document.getElementById('username').textContent;

            if (storedUsername && currentUsername && storedUsername !== currentUsername) {
                // L'utilisateur a changÃ© dans un autre onglet
                showMessage('Session expired: Another user logged in', true);
                document.getElementById('logout-btn').click();
            }
        }, 1000);

        function showMessage(text, isError = false) {
            message.textContent = text;
            message.className = `message ${isError ? 'error' : 'success'}`;
            setTimeout(() => message.className = 'message hidden', 5000);
        }

        function showWelcome(username) {
            document.getElementById('username').textContent = username;
            authForms.classList.add('hidden');
            welcome.classList.remove('hidden');
            shouldReconnect = true; // RÃ©activer les reconnexions
            connectWebSocket();  // Ã‰tablir la connexion WebSocket
        }

        // Fonction pour Ã©tablir la connexion WebSocket avec reconnexion automatique
        async function connectWebSocket() {
            if (!shouldReconnect) return;

            // VÃ©rifier les tokens avant de tenter une connexion
            const tokensValid = await areTokensValid();
            if (!tokensValid) {
                shouldReconnect = false;
                return;
            }

            if (ws) {
                ws.close();
                ws = null;
            }

            ws = new WebSocket(WS_URL);
            let reconnectTimeout;

            ws.onopen = () => {
                console.log('WebSocket connected');
                clearTimeout(reconnectTimeout);
                // Demander la liste des utilisateurs en ligne
                ws.send(JSON.stringify({ type: 'get_online_users' }));
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                switch (data.type) {
                    case 'status_update':
                        updateUserStatus(data);
                        break;
                    case 'online_users':
                        updateOnlineUsers(data.users);
                        break;
                }
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                // Tentative de reconnexion aprÃ¨s 5 secondes
                if (shouldReconnect) {
                    reconnectTimeout = setTimeout(() => {
                        connectWebSocket();
                    }, 5000);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        // Mise Ã  jour du statut d'un utilisateur
        function updateUserStatus(data) {
            const searchResult = document.getElementById('search-result');
            const userElement = searchResult.querySelector(`[data-username="${data.username}"]`);

            if (userElement) {
                const statusBadge = userElement.querySelector('.status-badge');
                statusBadge.textContent = data.online ? 'Online' : 'Offline';
                statusBadge.className = `status-badge ${data.online ? 'online' : 'offline'}`;
            }
        }

        // Mise Ã  jour de la liste des utilisateurs en ligne
        function updateOnlineUsers(onlineUsers) {
            const searchResult = document.getElementById('search-result');
            if (!searchResult) return;

            const statusBadge = searchResult.querySelector('.status-badge');
            if (statusBadge) {
                const userElement = searchResult.querySelector('.friend-item');
                if (userElement) {
                    const username = userElement.dataset.username;
                    const isOnline = onlineUsers.includes(username);
                    statusBadge.textContent = isOnline ? 'Online' : 'Offline';
                    statusBadge.className = `status-badge ${isOnline ? 'status-online' : 'status-offline'}`;
                }
            }
        }

        // Ajouter des styles pour les badges de statut
        const style = document.createElement('style');
        style.textContent = `
            .status-badge {
                padding: 2px 6px;
                border-radius: 10px;
                font-size: 0.8em;
                margin-left: 8px;
            }
            .status-badge.online {
                background-color: #2e7d32;
                color: white;
            }
            .status-badge.offline {
                background-color: #c62828;
                color: white;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>

</html>